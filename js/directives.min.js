!function(e){e.module("mpsDirectives",[]).directive("splash",[function(){return{restrict:"A",link:function(e,t,n){t.on("transitionend",function(){$(this).remove()}).css("opacity",0)}}}]).directive("modalAlert",[function(){return{restrict:"EACM",templateUrl:"./tpls/components/modalAlert.html",replace:!0,link:function(e,t,n){function i(){var e=t,n=e.find(".modal-dialog");e.css("display","block"),n.css("margin-top",Math.max(0,($(window).height()-n.height())/2)),e.css("display","")}e.$watch("modal",function(e,t){e!==t&&i()},!0),$(window).on("resize",function(){$(".modal:visible").each(i)})}}}]).directive("canvas",["$timeout","$window",function(e,t){return{restrict:"E",link:function(t,n,i){function o(){n.prop("width",t.variables.parentWidth),n.prop("height",t.variables.parentHeight)}i.hasOwnProperty("fillSize")&&(t.variables={get parentWidth(){return n.parent().width()},get parentHeight(){return n.parent().height()}},o(),t.$watch("variables",function(t,n){t!==n&&e(function(){o()})},!0))}}}]).directive("canvasSrc",["FileSrv","$timeout",function(e,t){return{restrict:"A",link:function(t,n,i){function o(t,o){t&&t!==o&&e.canvasRender(n[0],i.canvasSrc)}t.size={get width(){return n.prop("width")},get height(){return n.prop("height")}},i.$observe("canvasSrc",o),t.$watch("size",o,!0)}}}]).directive("spinner",[function(){return{restrict:"EACM",template:'<div class="shade" ng-if="spinnerShow"><div class="loader"><div></div><div></div><div></div><div></div></div></div>',replace:!0,link:function(e){e.$watch("spinnerShow",function(e,t){e!==t&&(e?$("body").css({overflow:"hidden",paddingRight:15}):$("body").css({overflow:"",paddingRight:""}))})}}}]).directive("repeatFinish",[function(){return{restrict:"A",link:function(e,t,n){1==e.$last&&e.$eval(n.repeatFinish)}}}]).directive("docMode",["$rootScope",function(e){return{restrict:"A",link:function(){}}}]).directive("myRadio",[function(){return{restrict:"E",template:function(e,t){return'<label><i class="fa" ng-class="{\'fa-circle-o\': !'+t.ngModel+", 'fa-dot-circle-o': "+t.ngModel+'}"></i><input type="radio" class="" ng-model="'+t.ngModel+'" name="'+t.name+'"><label>'},replace:!0,link:function(e,t,n){t.find("input[type=radio]").on("change",function(){e.$apply()})}}}]).directive("cameraView",[function(){return{restrict:"E",template:"tpls/components/cameraView.html",replace:!0,scope:{allowcapture:"=allowcapture",oncapture:"=oncapture"},link:function(e,t,n){var i=t.find("canvas")[0],o=i.getContext("2d"),a=t.find("video")[0],r={audio:!1,video:{width:{min:1280},height:{min:720}}},c={audio:!1,video:{optional:[{minWidth:320},{minWidth:640},{minWidth:1024},{minWidth:1280},{minWidth:1920},{minWidth:2560}]}},s=function(t){console.log("Video capture error: ",t.code),e.permission=!1};a.onloadeddata=function(){e.loaded=!0,e.$apply("loaded"),i.width=a.videoWidth,i.height=a.videoHeight};var d;navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia(r).then(function(t){d=t,e.permission=!0,e.$apply("permission"),a.src=window.URL.createObjectURL(t),a.play()}).catch(s):navigator.getUserMedia?navigator.getUserMedia(c,function(t){d=t,e.permission=!0,e.$apply("permission"),a.src=window.URL.createObjectURL(t),a.play()},s):navigator.webkitGetUserMedia?navigator.webkitGetUserMedia(c,function(t){d=t,e.permission=!0,e.$apply("permission"),a.src=window.webkitURL.createObjectURL(t),a.play()},s):navigator.mozGetUserMedia&&navigator.mozGetUserMedia(c,function(t){d=t,e.permission=!0,e.$apply("permission"),a.src=window.URL.createObjectURL(t),a.play()},s);var l=t.find(".flash-light");e.flash=function(){l.show(),o.drawImage(a,0,0,a.videoWidth,a.videoHeight),i.toBlob(function(t){var n=new File([t],Date.now()+".jpg",{type:"image/jpeg",size:t.size});e.oncapture&&e.oncapture(n)},"image/jpeg",.7)},l.on("animationend",function(){l.hide()}),e.$on("$destroy",function(){d&&d.getTracks()[0].stop()})}}}]).directive("modalMap",["$timeout",function(e){return{restrict:"A",link:function(t,n,i){i.modalMap&&!JSON.parse(i.modalMap)||!i.target||e(function(){var e=$('<div class="modal fade" id="'+i.target+'" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button><h4 class="modal-title" id="myModalLabel">查看详情</h4></div><div class="modal-body"></div></div></div></div>'),o=e.find(".modal-body");n.on("mousedown",function(){var t=$('[modalmap-id="'+i.target+'"]');t&&(n.attr({"data-target":"#"+i.target,"data-toggle":"modal"}),e.prop("id",i.target),o.html(t.html()))}),$(document.body).append(e),t.$on("$destroy",function(){$("#"+i.target).remove(),$('[data-target="#'+i.target+'"]').remove()})})}}}]).directive("zoomPop",["$timeout","$window",function(e,t){return{restrict:"A",link:function(e,t,n){var i,o,a,r,c=t.find("img"),s=t.parent();c.on("load",function(e){o=s.height(),(i=s.height()/e.target.height*e.target.width)>s.width&&(i=s.width,o=s.height()/e.target.width*e.target.height),t.css({width:i,height:o}),a?(r.teardown(),r._init()):(a=t.addClass("easyzoom easyzoom--adjacent").easyZoom(),r=a.data("easyZoom"))}),Object.defineProperty(e,"imgSrc",{get:function(){return t.find("img").attr("src")}})}}}]).directive("pdfViewer",["$window",function(e){return{restrict:"AE",link:function(e,t,n){function i(e,n){e.getPage(n).then(function(e){var n=document.createElement("canvas"),i=n.getContext("2d"),o=e.getViewport(1.3333333333333333);n.height=o.height,n.width=o.width;var a={canvasContext:i,viewport:o};e.render(a),t.prepend(n)})}function o(){n.pdfSrc&&(t.empty(),PDFJS.getDocument(n.pdfSrc).then(function(e){if(a)for(var t=e.numPages;t--;)i(e,t+1);else i(e,1)}))}PDFJS.imageResourcesPath="lib/pdfjs/build/generic/web/images/",PDFJS.workerSrc="lib/pdfjs/build/generic/build/pdf.worker.js",PDFJS.cMapUrl="lib/pdfjs/build/generic/web/cmaps/",PDFJS.cMapPacked=!0;var a=n.hasOwnProperty("multiple");n.$observe("pdfSrc",o)}}}]).directive("scaleBox",[function(){return{restrict:"AE",template:'<div class="scale-box" ng-class="scaleModeMap[scaleMode].className"><div ng-transclude></div><button class="scale-switch btn" ng-click="switchScale()">{{scaleModeMap[scaleMode].text}}<span class="rippleJS"></span></button></div>',transclude:!0,replace:!0,link:function(e,t,n){e.scaleMode=0,e.scaleModeMap=[{text:"原始尺寸",className:"auto"},{text:"自适应",className:"origin"}],e.switchScale=function(){e.scaleMode=e.scaleMode+1<e.scaleModeMap.length?e.scaleMode+1:0}}}}]).directive("transition",["$window","$state","$timeout",function(e,t,n){return{restrict:"AE",template:"<div ng-transclude></div>",replace:!0,transclude:!0,link:function(t,n,i){var o,a,r,c=i.name||"transition";n.addClass(c+"-transition"),t.$on("$stateChangeStart",function(e){o=Date.now(),n.addClass(c+"-leave")}),t.$on("$stateChangeSuccess",function(){a=Date.now(),r=a-o;var t=1e3*parseFloat(n.css("transitionDuration")),i=r>t?0:t;e.setTimeout(function(){n.removeClass(c+"-leave").addClass(c+"-enter"),e.setTimeout(function(){n.removeClass(c+"-enter")},t)},i)})}}}]).directive("routerSpinner",["$window",function(e){return{restrict:"AE",template:'<div class="router-spinner"></div>',replace:!0,transclude:!0,link:function(t,n,i){var o,a;t.$on("$stateChangeStart",function(){o&&e.clearInterval(o),a=0,n.css({transition:"none",opacity:1,width:a+"%"}),n.show(),o=e.setInterval(function(){a+=(70-a)/100,n.css({width:a+"%"})},16.7)}),t.$on("$stateChangeSuccess",function(){e.clearInterval(o),n.css({transition:"",width:"100%"});var t=1e3*parseFloat(n.css("transitionDuration"));e.setTimeout(function(){n.css({opacity:0}),e.setTimeout(function(){n.hide()},t)},t)})}}}]).directive("queueTrans",["$timeout",function(e){return{restrict:"AE",link:function(t,n,i){function o(){r.each(function(e,t){t.style.animationDuration=c+"s",t.style.animationDelay=e*s+"s"}).addClass(i.animateClass)}function a(e){var t=n.offset().top+d<$(window).scrollTop()+$(window).height();return t&&(o(),e&&e()),t}i.animateClass;var r,c=i.animateDuration?parseFloat(i.animateDuration):.5,s=i.animateInterval?parseFloat(i.animateInterval):.1,d=i.delayPixel||200;e(function(){(r=n.children()).css({opacity:"0"}).one("animationstart",function(){$(this).css("opacity","")}).one("animationend",function(){$(this).css({animationDuration:"",animationDelay:""})});var e=function(){a(function(){$(window).off("scroll",e)})};a()||$(window).on("scroll",e)})}}}]).directive("loginModal",["$rootScope","$http","Api","UI","$window",function(e,t,n,i,o){return{restrict:"AE",replace:!0,templateUrl:"./tpls/components/loginModal.html",link:function(i,a,r){var c=a;r.$observe("modal",function(e,t){e!==t&&c.modal(e?"show":"hide")}),i.login=function(){i.loading=!0,t({method:"POST",url:n.login,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-Requested-With":"XMLHttpRequest"},data:"userName="+i.loginUsername+"&password="+i.loginPassword}).then(function(t){"success"===t.data.state?(o.localStorage.setItem("token",t.data.token),e.getLoginStatus(),e.$broadcast("loginSuccess"),e.notify.open({title:"成功",content:"登录成功！",type:"success"})):e.notify.open({title:"错误",content:t.data.message,type:"error"}),i.loading=!1})}}}}]).directive("backToTop",[function(){return{restrict:"A",link:function(e,t,n){var i=$(window);Object.defineProperty(e,"show",{get:function(){return i.scrollTop()>100}}),i.on("scroll",function(t){t.stopPropagation(),e.$apply("show")}),e.$watch("show",function(e,n){e!==n&&t[(e?"add":"remove")+"Class"]("show")},!0),t.click(function(){$("html, body").animate({scrollTop:0},500)})}}}]).directive("somewhatClouds",["$rootScope","$timeout",function(e,t){return{restrict:"AE",replace:!0,link:function(n,i,o){function a(){t(function(){var e=i.find(">li.active");if(e.length){var t=e.offset().left,n=e.width();r.css({left:t,width:n})}else r.css({width:""})})}var r=$("<div>").addClass("somewhat-clouds");i.after(r),e.$on("$stateChangeSuccess",function(){a()}),$(window).on("resize",function(){a()})}}}]).directive("dynamicScroll",["$timeout",function(e){return{restrict:"A",link:function(e,t,n){t.click(function(){var e=$(n.dynamicScroll);if(e.length){var t=e.offset().top;$("html, body").animate({scrollTop:t},500)}})}}}]).directive("fixedQrcode",[function(){return{restrict:"E",templateUrl:"./tpls/components/fixedQrcode.html",replace:!0,link:function(e,t,n){e.hideQrCode=!1}}}]).directive("cropper",["$timeout",function(e){return{restrict:"A",scope:{cropper:"=cropper"},link:function(e,t,n){var i;e.$watch("cropper",function(n,o){n&&(n.id!==(o&&o.id)&&i&&i.destroy(),!n||!n.enable||o&&o.enable&&n.id===o.id||(i=new Cropper(t[0],{viewMode:1,dragMode:"move",data:e.cropper.data||{}})))},!0),t.on("ready cropend zoom",function(t){"ready"===t.type&&e.cropper.data||e.$emit("cropchange"),e.cropper.data=i&&i.getData()})}}}]).directive("swiper",["$timeout",function(e){return{restrict:"A",scope:{swiper:"=swiper"},link:function(t,n,i){var o={navigation:{nextEl:n.find(".swiper-button-next"),prevEl:n.find(".swiper-button-prev")}};t.swiper&&$.extend(o,t.swiper);var a=new Swiper(n,o);a.on("slideChange",function(){t.$emit("swiperSlideChange",a.activeIndex)}),i.$observe("activeIndex",function(t,n){var i=~~t;t!==n&&i!==a.activeIndex&&e(function(){a.slideTo(t)})})}}}]).directive("notify",["$rootScope","$timeout",function(e,t){var n=[];return{restrict:"AE",templateUrl:"tpls/components/notify.html",scope:{api:"=api"},replace:!0,link:function(e,i,o){e.notifyList=n;var a=i.find(".notify-list"),r=a.find(".notify-item");r.remove(),e.api={open:function(n){var i=this,o={id:UUID.generate(),title:"Notify title",content:"Notify content.",type:"default",time:5e3,delay:0};n=n&&"object"==typeof n?n:{},o.title=n.title?n.title:o.title,o.content=n.content?n.content:o.content;var c=["default","success","info","warning","error"];o.type=n.type&&-1!==c.indexOf(n.type)?n.type:o.type;var s={default:"fa-bell",success:"fa-check-circle",info:"fa-info-circle",warning:"fa-exclamation-circle",error:"fa-times-circle"};o.iconClass=s[o.type],o.time=n.time?n.time:o.time,e.notifyList.push(o.id);var d=r.clone();d.attr("data-notify-id",o.id).html(d.html().replace(/(&lt;%.+?%&gt;)|(<%.+?%>)/g,function(e){return o[e.replace(/(<%)|(%>)|(&lt;%)|(%&gt;)/g,"")]})),a.append(d),t(function(){var e=d.height();d.height(0),window.setTimeout(function(){d.height(e)});var t=100/(o.time/1e3*60),n=!1;d.on("mouseover",function(){n=!0}).on("mouseleave",function(){n=!1});var a=d.find(".progress"),r=100,c=window.setInterval(function(){n||(r-=t,a.width(r+"%")),r<=0&&(window.clearInterval(c),d.parent().length&&i.close(o.id))},1e3/60)}),d.find("button.close").on("click",function(e){i.close($(e.currentTarget).data("target-id"))})},close:function(t){var n=i.find('[data-notify-id="'+t+'"]');n.find(".notify").addClass("in-close").on("transitionend",function(i){n.on("transitionend",function(i){i.target===n[0]&&(n.remove(),e.notifyList.slice(e.notifyList.indexOf(t),1))}).height(0)})}}}}}]).directive("vatCheck",["NetSrv","Api","$rootScope","$timeout",function(e,t,n,i){return{restrict:"AE",templateUrl:"tpls/components/vatCheck.html",replace:!0,scope:{data:"=data",apiKey:"=apiKey"},link:function(o,a,r){o.checkParams=o.data.result.mpRecognition.ocrInfoList?o.data.result.mpRecognition.ocrInfoList.ocrInfo.ocrResult.ocrData:{invoiceType:"增值税专用发票",invoiceCode:"",invoiceNumber:"",date:"",checkCode:"",totalPrice:""},o.manualIntervene=function(r){o.vatCheckForm.$invalid||(o.checkParams.apiKey=o.apiKey,o.loading=!0,e.ajaxFw({url:t.vatCheck,params:o.checkParams,success:function(e){if(o.loading=!1,e.code&&"00000"===e.code&&e.result.resCode&&"1"===e.result.resCode){n.notify.open({title:"成功",content:"人工干预完成，识别结果已更新。",type:"success"});var t=function(){i(function(){o.data.result.mpRecognition.resCd=e.code,o.data.result.mpRecognition.resMsg=e.message,o.data.result.mpRecognition.requestId=e.requestId,o.data.result.mpRecognition.ocrInfoList=o.data.result.mpRecognition.ocrInfoList?o.data.result.mpRecognition.ocrInfoList:{ocrInfo:{}},o.data.result.mpRecognition.ocrInfoList.ocrInfo.ocrResult=e.result})},r=a.parents(".modal");r.length?r.on("hidden.bs.modal",function(e){t()}).modal("hide"):t()}else n.notify.open({title:"失败",content:e.result&&e.result.resCode?e.result.resMessage:e.message,type:"error"})},headers:{"X-Requested-With":void 0},failAlert:!0,spinner:!1}))}}}}]).directive("busLisQuery",["NetSrv","Api","$rootScope","$timeout",function(e,t,n,i){return{restrict:"AE",templateUrl:"tpls/components/busLisQuery.html",replace:!0,scope:{data:"=data"},link:function(i,o,a){var r=function(n){return e.ajaxFw({url:t.busLisQuery,headers:{"X-Requested-With":void 0},params:n,success:function(e){i.data.queryResult=e}})};Object.defineProperty(i,"entName",{get:function(){var e=i.data.result.mpRecognition.ocrInfoList.ocrInfo.ocrResult;return e.businessLicenseName||e.socialCreditCode||e.registrationNumber}}),i.queryAfterOCR=function(){i.$parent.checkLogin().then(function(e){r({apiKey:e,entName:i.entName})})},i.form={},i.queryManual=function(e){i.form.busLisQueryForm.$invalid||(i.loading=!0,i.$parent.checkLogin().then(function(e){r({apiKey:e,entName:i.entName}).then(function(e){if(i.loading=!1,e.code&&"00000"===e.code){n.notify.open({title:"成功",content:"人工干预完成。",type:"success"});var t=o.find(".modal:visible");t.length?t.on("hidden.bs.modal",function(t){i.data.queryResult=e}).modal("hide"):i.data.queryResult=e}else n.notify.open({title:"失败",content:e.code?e.message:"未知错误。",type:"error"})})}))},i.trans={enterpriseName:"企业名称",frName:"法人姓名",regNo:"工商注册号",creditCode:"统一社会信用代码",regCap:"注册资金(单位:万元)",regCapCur:"注册币种",regOrg:"登记机关",esDate:"开业日期",openFrom:"经营期限自",openTo:"经营期限至",enterpriseType:"企业(机构)类型",enterpriseStatus:"经营状态",cancelDate:"注销日期",revokeDate:"吊销日期",orgCode:"组织机构代码",operateScope:"经营(业务)范围",apprDate:"核准时间",address:"注册地址",province:"省",city:"地级市",county:"区 / 县",areaCode:"所在行政区划代码",industryPhyCode:"行业门类代码",industryPhyName:"行业门类名称",industryCode:"国民经济行业代码",industryName:"国民经济行业名称"}}}}]).directive("blockProgress",[function(){return{templateUrl:"tpls/components/blockProgress.html",replace:!0}}])}(window.angular);
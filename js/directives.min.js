!function(e){e.module("mpsDirectives",[]).directive("modalAlert",[function(){return{restrict:"EACM",template:'<div class="modal fade alert-modal-lg" id="modalAlert" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"><div class="modal-dialog" ng-class="modal.alert.size"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button><h4 class="modal-title" id="myModalLabel" ng-bind="modal.alert.title">Modal title</h4></div><div class="modal-body" ng-bind-html="modal.alert.content"></div><div class="modal-footer" ng-if="modal.alert.footer"><button type="button" class="btn btn-primary" data-dismiss="modal">确定</button></div></div></div></div>',replace:!0,link:function(e,t,i){function a(){var e=t,i=e.find(".modal-dialog");e.css("display","block"),i.css("margin-top",Math.max(0,($(window).height()-i.height())/2)),e.css("display","")}e.$watch("modal",function(e,t){e!==t&&a()},!0),$(window).on("resize",function(){$(".modal:visible").each(a)})}}}]).directive("canvas",["$timeout","$window",function(e,t){return{restrict:"E",link:function(t,i,a){function n(){i.prop("width",t.variables.parentWidth),i.prop("height",t.variables.parentHeight)}a.hasOwnProperty("fillSize")&&(t.variables={get parentWidth(){return i.parent().width()},get parentHeight(){return i.parent().height()}},n(),t.$watch("variables",function(t,i){t!==i&&e(function(){n()})},!0))}}}]).directive("canvasSrc",["FileSrv","$timeout",function(e,t){return{restrict:"A",link:function(t,i,a){function n(t,n){t&&t!==n&&e.canvasRender(i[0],a.canvasSrc)}t.size={get width(){return i.prop("width")},get height(){return i.prop("height")}},a.$observe("canvasSrc",n),t.$watch("size",n,!0)}}}]).directive("spinner",[function(){return{restrict:"EACM",template:'<div class="shade" ng-if="spinnerShow"><div class="loader"></div></div>',replace:!0,link:function(e){e.$watch("spinnerShow",function(e,t){e!==t&&(e?$("body").css({overflow:"hidden",paddingRight:15}):$("body").css({overflow:"",paddingRight:""}))})}}}]).directive("repeatFinish",[function(){return{restrict:"A",link:function(e,t,i){console.log(e.$index),1==e.$last&&e.$eval(i.repeatFinish)}}}]).directive("docMode",["$rootScope",function(e){return{restrict:"A",link:function(){}}}]).directive("myRadio",[function(){return{restrict:"E",template:function(e,t){return'<label><i class="fa" ng-class="{\'fa-circle-o\': !'+t.ngModel+", 'fa-dot-circle-o': "+t.ngModel+'}"></i><input type="radio" class="" ng-model="'+t.ngModel+'" name="'+t.name+'"><label>'},replace:!0,link:function(e,t,i){t.find("input[type=radio]").on("change",function(){e.$apply(),console.log(e)})}}}]).directive("cameraView",[function(){return{restrict:"E",template:'<div class="camera-view"><video ng-show="permission"></video><div class="denied" ng-if="!permission"><i class="fa fa-video-camera"></i><p>未检测到摄像头，确认摄像头已连接并允许浏览器使用。</p></div><canvas class="hidden"></canvas><div class="flash-light"></div><div class="capture" ng-if="permission && allowcapture && loaded" ng-click="flash()"><i class="fa fa-camera"></i></div></div>',replace:!0,scope:{allowcapture:"=allowcapture",oncapture:"=oncapture"},link:function(e,t,i){console.log(e);var a=t.find("canvas")[0],n=a.getContext("2d"),o=t.find("video")[0],s={audio:!1,video:{width:{min:1280},height:{min:720}}},r={audio:!1,video:{optional:[{minWidth:320},{minWidth:640},{minWidth:1024},{minWidth:1280},{minWidth:1920},{minWidth:2560}]}},d=function(t){console.log("Video capture error: ",t.code),e.permission=!1};o.onloadeddata=function(){e.loaded=!0,e.$apply("loaded"),a.width=o.videoWidth,a.height=o.videoHeight};var c;navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia(s).then(function(t){c=t,e.permission=!0,e.$apply("permission"),o.src=window.URL.createObjectURL(t),o.play()}).catch(d):navigator.getUserMedia?navigator.getUserMedia(r,function(t){c=t,e.permission=!0,e.$apply("permission"),o.src=window.URL.createObjectURL(t),o.play()},d):navigator.webkitGetUserMedia?navigator.webkitGetUserMedia(r,function(t){c=t,e.permission=!0,e.$apply("permission"),o.src=window.webkitURL.createObjectURL(t),o.play()},d):navigator.mozGetUserMedia&&navigator.mozGetUserMedia(r,function(t){c=t,e.permission=!0,e.$apply("permission"),o.src=window.URL.createObjectURL(t),o.play()},d);var l=t.find(".flash-light");e.flash=function(){l.show(),n.drawImage(o,0,0,o.videoWidth,o.videoHeight),a.toBlob(function(t){var i=new File([t],Date.now()+".jpg",{type:"image/jpeg",size:t.size});e.oncapture&&e.oncapture(i)},"image/jpeg",.7)},l.on("animationend",function(){l.hide()}),e.$on("$destroy",function(){c&&c.getTracks()[0].stop()})}}}]).directive("modalMap",[function(){return{restrict:"A",link:function(e,t,i){if(!i.modalMap||JSON.parse(i.modalMap)){var a=function(){var e=t.html(),i="modalMap"+Date.now(),a=['<div class="modal fade" id="'+i+'" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button><h4 class="modal-title" id="myModalLabel">查看详情</h4></div><div class="modal-body">',e,"</div></div></div></div>"],n=$(a.join("")),o=n.find(".modal-body"),s='<button class="full-screen" title="查看详情" data-toggle="modal" data-target="#'+i+'"><i></i><span>查看详情</span></button>',r=$(s);return r.click(function(){o.html(t.html())}),$(document.body).append(n),t.after(r),i}();e.$on("$destroy",function(){$("#"+a).remove(),$('[data-target="#'+a+'"]').remove()})}}}}]).directive("zoomPop",["$timeout","$window",function(e,t){return{restrict:"A",link:function(e,t,i){var a,n,o,s,r=t.find("img"),d=t.parent();r.on("load",function(e){n=d.height(),(a=d.height()/e.target.height*e.target.width)>d.width&&(a=d.width,n=d.height()/e.target.width*e.target.height),t.css({width:a,height:n}),o?(s.teardown(),s._init()):(o=t.addClass("easyzoom easyzoom--adjacent").easyZoom(),s=o.data("easyZoom"))}),Object.defineProperty(e,"imgSrc",{get:function(){return t.find("img").attr("src")}})}}}]).directive("pdfViewer",["$window",function(e){return{restrict:"AE",link:function(e,t,i){function a(e,i){e.getPage(i).then(function(e){var i=document.createElement("canvas"),a=i.getContext("2d"),n=e.getViewport(1.3333333333333333);i.height=n.height,i.width=n.width;var o={canvasContext:a,viewport:n};e.render(o),t.prepend(i)})}function n(){i.pdfSrc&&(t.empty(),PDFJS.getDocument(i.pdfSrc).then(function(e){if(o)for(var t=e.numPages;t--;)a(e,t+1);else a(e,1)}))}PDFJS.imageResourcesPath="lib/pdfjs/build/generic/web/images/",PDFJS.workerSrc="lib/pdfjs/build/generic/build/pdf.worker.js",PDFJS.cMapUrl="lib/pdfjs/build/generic/web/cmaps/",PDFJS.cMapPacked=!0;var o=i.hasOwnProperty("multiple");i.$observe("pdfSrc",n)}}}]).directive("scaleBox",[function(){return{restrict:"AE",template:'<div class="scale-box" ng-class="scaleModeMap[scaleMode].className"><div ng-transclude></div><button class="scale-switch" ng-click="switchScale()">{{scaleModeMap[scaleMode].text}}</button></div>',transclude:!0,replace:!0,link:function(e,t,i){e.scaleMode=0,e.scaleModeMap=[{text:"原始尺寸",className:"auto"},{text:"自适应",className:"origin"}],e.switchScale=function(){e.scaleMode=e.scaleMode+1<e.scaleModeMap.length?e.scaleMode+1:0}}}}]).directive("transition",["$window",function(e){return{restrict:"AE",template:"<div ng-transclude></div>",replace:!0,transclude:!0,link:function(t,i,a){var n,o,s,r=a.name||"transition";t.$on("$stateChangeStart",function(){n=Date.now(),i.addClass([r+"-transition",r+"-enter"].join(" "))}),t.$on("$stateChangeSuccess",function(){o=Date.now(),s=o-n;var t=1e3*parseFloat(i.css("transitionDuration")),a=s>t?s:t;e.setTimeout(function(){i.removeClass(r+"-enter").addClass(r+"-leave"),e.setTimeout(function(){i.removeClass([r+"-leave",r+"-transition"].join(" "))},t)},a)})}}}]).directive("routerSpinner",["$window",function(e){return{restrict:"AE",template:'<div class="router-spinner"></div>',replace:!0,transclude:!0,link:function(t,i,a){var n,o;t.$on("$stateChangeStart",function(){o=0,i.css({transition:"none",opacity:1,width:o+"%"}),i.show(),n=e.setInterval(function(){o+=(70-o)/100,i.css({width:o+"%"})},16.7)}),t.$on("$stateChangeSuccess",function(){e.clearTimeout(n),i.css({transition:"",width:"100%"});var t=1e3*parseFloat(i.css("transitionDuration"));e.setTimeout(function(){i.css({opacity:0}),e.setTimeout(function(){i.hide()},t)},t)})}}}])}(window.angular);